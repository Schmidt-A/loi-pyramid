<html>
  <head>
    <script type="module" src="../utils/tables.js"></script>
    <script type="module" src="../utils/templates.js"></script>

    <script type="module" src="account_table.js"></script>
    <script type="module" src="character_table.js"></script>
    <script type="module" src="login_form.js"></script>

  </head>
  <body>

    <select id="pageOptions">
      <option value="">Pick a page</option>
      <option value="templateTester">Template Tester</option>
    </select>

    <div id="pageContainer"> </div>

    <script type="module">
      import templates from '../utils/templates.js'
      import characterTable from './character_table.js'
      import accountTable from './account_table.js'
      import loginForm from './login_form.js'
      import { dataset } from '../utils/datasets.js'

      sessionStorage.clear()

      const accountFixture = {"username": "Tweek", "password": "dragon4ever", "cdkey": "efgh5678", "role": 3, "approved": 1, "banned": 0, "created": "23/11/2017","updated": "29/11/2017"}

      const characterFixture = {"characters":[{"id":1,"accountId":"Tweek","name":"Siobhan Faulkner","exp":10000,"area":"Hlammach Docks","created":"23/11/2017","updated":"29/11/2017"},{"id":2,"accountId":"Aez","name":"Alrunden Peralt","exp":12000,"area":"Dreyen Inn","created":"26/6/2017","updated":"29/11/2017"},{"id":3,"accountId":null,"name":"Arthen Relindar","exp":20000,"area":"Relindar Green","created":null,"updated":null},{"id":4,"accountId":"XxDrizzitxX","name":"Ji'Lin Thri'quen","exp":1050,"area":"Dreyen Inn","created":"29/11/2017","updated":"29/11/2017"}],"total":4, "offset":4}

      sessionStorage.setItem('account', JSON.stringify(accountFixture))
      sessionStorage.setItem('accountCharacters', JSON.stringify(characterFixture))

      let templatePageMarkup = 
      `<div id="templateChoiceContainer"></div>`

      let templateChoiceMarkup = 
        `<select id="templateOptions">
          <option value="">Pick a template</option>
          <option value="loginForm">Login Form</option>
          <option value="accountTable">Account Table</option>
          <option value="characterTable">Character Table</option>
        </select>

        <div id="contentContainer"></div>`

      let pageOptions = document.querySelector('#pageOptions')

      let templateChoiceListener = templates.listener(
        'select',
        'change',
        function (event) {
          switch (event.target.value) {
          case 'loginForm':
          // try to use a spread operator for the template conversion
            let testLoginForm = templates.content( 
              { 
                markup: loginForm.markup,
                listeners: [templates.listener(
                  'form',
                  'submit',
                  function (event) {
                    event.preventDefault()
                      let formData = new FormData(event.srcElement)
                      for (let input of formData.entries()) {
                        console.log(`${input[0]}: ${input[1]}`)
                      }
                    },
                  )],
                dataset: loginForm.dataset,
                renderData: function (container) {return Promise.resolve()}
              },
              document.querySelector('#contentContainer'))
            testLoginForm.render()
            break
          case 'accountTable':
            let testAccountTable = templates.content( 
              {
                markup: accountTable.markup,
                listeners: accountTable.listeners,
                dataset: dataset(
                  'account',
                  function () {
                    return Promise.resolve(accountFixture)
                  }),
                renderData: accountTable.renderData
              },
              document.querySelector('#contentContainer'))
            testAccountTable.render()
            break
          case 'characterTable':
            let testCharacterTable = templates.content( 
              {
                markup: characterTable.markup,
                listeners: characterTable.listeners,
                dataset: dataset(
                  'accountCharacters',
                  function () {
                    return Promise.resolve(characterFixture)
                }),
                renderData: characterTable.renderData,
              },
              document.querySelector('#contentContainer'))
            testCharacterTable.render()
            break
          }
        })

      let templateChoiceTemplate = {
        markup: templateChoiceMarkup,
        listeners: [templateChoiceListener],
        dataset: null,
        renderData: () => { return Promise.resolve()}
        }

      let templatePageMap = {
        'templateChoiceContainer': templateChoiceTemplate
      }

      let templateChoicePage = templates.page(
        'template_test',
        templatePageMarkup,
        templatePageMap,
        )

      pageOptions.addEventListener('change', event => {
        event.preventDefault()
        switch (event.target.value) {
          case 'templateTester':
            templateChoicePage.render(document.querySelector('#pageContainer'))
            break
        }
      })


    </script>

  </body>
</html>